import React, { useState } from 'react';
import {
  Box,
  Typography,
  useTheme,
  IconButton,
  Tooltip,
  alpha,
} from '@mui/material';
import { motion } from 'framer-motion';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { oneDark, oneLight } from 'react-syntax-highlighter/dist/esm/styles/prism';

// ChatGPT-style icons
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import CheckIcon from '@mui/icons-material/Check';
import ThumbUpIcon from '@mui/icons-material/ThumbUp';
import ThumbDownIcon from '@mui/icons-material/ThumbDown';
import { formatTime } from '../../../common/utils/dateUtils';
import type { Message } from '../types';

interface ChatMessageProps {
  message: Message;
  isLoading?: boolean;
}

import './ChatMessage.css';


function ChatMessage({ message, isLoading }: ChatMessageProps) {
  const theme = useTheme();
  const [copied, setCopied] = useState(false);
  const [liked, setLiked] = useState(false);
  const [disliked, setDisliked] = useState(false);
  const [showActions, setShowActions] = useState(false);

  const isAI = message.author === 'Assistant';
  const isUser = message.author === 'User';

  const handleCopyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(message.content);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy text:', err);
    }
  };

  const handleLike = () => {
    setLiked(!liked);
    if (disliked) setDisliked(false);
  };

  const handleDislike = () => {
    setDisliked(!disliked);
    if (liked) setLiked(false);
  };

  // Loading skeleton for AI responses - no avatar, pure minimal
  const renderLoadingSkeleton = () => (
    <Box className="chat-message ai-message">
      <Box className="message-container">
        <Box className="loading-content">
          <Typography
            sx={{
              color: theme.palette.text.secondary,
              fontSize: '15px',
              fontStyle: 'italic',
              display: 'flex',
              alignItems: 'center',
              gap: 1,
            }}
          >
            Thinking
            <Box className="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </Box>
          </Typography>
        </Box>
      </Box>
    </Box>
  );

  if (isLoading) {
    return renderLoadingSkeleton();
  }

  return (
    <Box
      component={motion.div}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4, ease: 'easeOut' }}
      className={`chat-message ${isUser ? 'user-message' : 'ai-message'}`}
      onMouseEnter={() => setShowActions(true)}
      onMouseLeave={() => setShowActions(false)}
    >
      <Box className="message-container">
        {/* Message Content */}
        <Box className={`message-content ${isUser ? 'user-bubble' : 'ai-content'}`}>
          {isUser ? (
            <Typography
              className="message-text"
              sx={{
                whiteSpace: 'pre-wrap',
                wordBreak: 'break-word',
                lineHeight: 1.6,
                fontSize: '15px',
                color: '#fff',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif',
              }}
            >
              {message.content}
            </Typography>
          ) : (
            <ReactMarkdown
              className="message-text markdown-content"
              components={{
                code({ node, inline, className, children, ...props }) {
                  const match = /language-(\w+)/.exec(className || '');
                  const language = match ? match[1] : '';
                  
                  return !inline && language ? (
                    <SyntaxHighlighter
                      style={theme.palette.mode === 'dark' ? oneDark : oneLight}
                      language={language}
                      PreTag="div"
                      customStyle={{
                        margin: '12px 0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        lineHeight: '1.5',
                      }}
                      {...props}
                    >
                      {String(children).replace(/\n$/, '')}
                    </SyntaxHighlighter>
                  ) : (
                    <code
                      style={{
                        backgroundColor: theme.palette.mode === 'dark' ? '#2d2d2d' : '#f6f8fa',
                        color: theme.palette.text.primary,
                        padding: '2px 4px',
                        borderRadius: '3px',
                        fontSize: '13px',
                        fontFamily: 'SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace',
                      }}
                      {...props}
                    >
                      {children}
                    </code>
                  );
                },
                p: ({ children }) => (
                  <Typography
                    component="p"
                    sx={{
                      margin: '0 0 12px 0',
                      lineHeight: 1.6,
                      fontSize: '15px',
                      color: theme.palette.text.primary,
                      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif',
                      '&:last-child': { marginBottom: 0 },
                    }}
                  >
                    {children}
                  </Typography>
                ),
                h1: ({ children }) => (
                  <Typography variant="h4" component="h1" sx={{ margin: '20px 0 10px 0', fontWeight: 600, color: theme.palette.text.primary, '&:first-of-type': { marginTop: 0 } }}>
                    {children}
                  </Typography>
                ),
                h2: ({ children }) => (
                  <Typography variant="h5" component="h2" sx={{ margin: '18px 0 8px 0', fontWeight: 600, color: theme.palette.text.primary, '&:first-of-type': { marginTop: 0 } }}>
                    {children}
                  </Typography>
                ),
                h3: ({ children }) => (
                  <Typography variant="h6" component="h3" sx={{ margin: '16px 0 6px 0', fontWeight: 600, color: theme.palette.text.primary, '&:first-of-type': { marginTop: 0 } }}>
                    {children}
                  </Typography>
                ),
                ul: ({ children }) => (
                  <Box component="ul" sx={{ margin: '12px 0', paddingLeft: '20px', '& li': { marginBottom: '4px', lineHeight: 1.5, color: theme.palette.text.primary } }}>
                    {children}
                  </Box>
                ),
                ol: ({ children }) => (
                  <Box component="ol" sx={{ margin: '12px 0', paddingLeft: '20px', '& li': { marginBottom: '4px', lineHeight: 1.5, color: theme.palette.text.primary } }}>
                    {children}
                  </Box>
                ),
                blockquote: ({ children }) => (
                  <Box
                    component="blockquote"
                    sx={{
                      borderLeft: `4px solid ${theme.palette.divider}`,
                      margin: '12px 0',
                      paddingLeft: '16px',
                      paddingY: '8px',
                      backgroundColor: theme.palette.mode === 'dark' ? '#2d2d2d' : '#f6f8fa',
                      borderRadius: '0 6px 6px 0',
                      fontStyle: 'italic',
                      color: theme.palette.text.secondary,
                    }}
                  >
                    {children}
                  </Box>
                ),
                a: ({ href, children }) => (
                  <Typography
                    component="a"
                    href={href}
                    target="_blank"
                    rel="noopener noreferrer"
                    sx={{
                      color: theme.palette.primary.main,
                      textDecoration: 'none',
                      '&:hover': { textDecoration: 'underline' },
                    }}
                  >
                    {children}
                  </Typography>
                ),
              }}
            >
              {message.content}
            </ReactMarkdown>
          )}
  alpha,
} from '@mui/material';
import { motion } from 'framer-motion';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { oneDark, oneLight } from 'react-syntax-highlighter/dist/esm/styles/prism';

// ChatGPT-style icons
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import CheckIcon from '@mui/icons-material/Check';
import ThumbUpIcon from '@mui/icons-material/ThumbUp';
import ThumbDownIcon from '@mui/icons-material/ThumbDown';
import { formatTime } from '../../../common/utils/dateUtils';
import type { Message } from '../types';

interface ChatMessageProps {
  message: Message;
  isLoading?: boolean;
}

import './ChatMessage.css';


function ChatMessage({ message, isLoading }: ChatMessageProps) {
  const theme = useTheme();
  const [copied, setCopied] = useState(false);
  const [liked, setLiked] = useState(false);
  const [disliked, setDisliked] = useState(false);
  const [showActions, setShowActions] = useState(false);

  const isAI = message.author === 'Assistant';
  const isUser = message.author === 'User';

  const handleCopyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(message.content);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy text:', err);
    }
  };

  const handleLike = () => {
    setLiked(!liked);
    if (disliked) setDisliked(false);
  };

  const handleDislike = () => {
    setDisliked(!disliked);
    if (liked) setLiked(false);
  };

  // Loading skeleton for AI responses - no avatar, pure minimal
  const renderLoadingSkeleton = () => (
    <Box className="chat-message ai-message">
      <Box className="message-container">
        <Box className="loading-content">
          <Typography
            sx={{
              color: theme.palette.text.secondary,
              fontSize: '15px',
              fontStyle: 'italic',
              display: 'flex',
              alignItems: 'center',
              gap: 1,
            }}
          >
            Thinking
            <Box className="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </Box>
          </Typography>
        </Box>
      </Box>
    </Box>
  );

  if (isLoading) {
    return renderLoadingSkeleton();
  }

  return (
    <Box
      component={motion.div}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4, ease: 'easeOut' }}
      className={`chat-message ${isUser ? 'user-message' : 'ai-message'}`}
      onMouseEnter={() => setShowActions(true)}
      onMouseLeave={() => setShowActions(false)}
    >
      <Box className="message-container">
        {/* Message Content */}
        <Box className={`message-content ${isUser ? 'user-bubble' : 'ai-content'}`}>
          <Typography
            className="message-text"
            sx={{
              whiteSpace: 'pre-wrap',
              wordBreak: 'break-word',
              lineHeight: 1.6,
              fontSize: '15px',
              color: isUser ? '#fff' : theme.palette.text.primary,
              fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", \"Roboto\", sans-serif',
            }}
          >
            {message.content}
          </Typography>

          {/* Action buttons for AI messages */}
          {isAI && (
            <Box
              className="message-actions"
              sx={{
                opacity: showActions ? 1 : 0,
                transition: 'opacity 0.2s ease',
                display: 'flex',
                alignItems: 'center',
                gap: 0.5,
                mt: 1,
                pt: 1,
              }}
            >
              <Tooltip title={copied ? 'Copied!' : 'Copy'}>
                <IconButton
                  size="small"
                  onClick={handleCopyToClipboard}
                  sx={{
                    color: theme.palette.text.secondary,
                    '&:hover': {
                      bgcolor: alpha(theme.palette.action.hover, 0.1),
                    },
                  }}
                >
                  {copied ? (
                    <CheckIcon sx={{ fontSize: 16 }} />
                  ) : (
                    <ContentCopyIcon sx={{ fontSize: 16 }} />
                  )}
                </IconButton>
              </Tooltip>

              <Tooltip title={liked ? 'Good response' : 'Like'}>
                <IconButton
                  size="small"
                  onClick={handleLike}
                  sx={{
                    color: liked ? '#10a37f' : theme.palette.text.secondary,
                    '&:hover': {
                      bgcolor: alpha(theme.palette.action.hover, 0.1),
                    },
                  }}
                >
                  <ThumbUpIcon sx={{ fontSize: 16 }} />
                </IconButton>
              </Tooltip>

              <Tooltip title={disliked ? 'Poor response' : 'Dislike'}>
                <IconButton
                  size="small"
                  onClick={handleDislike}
                  sx={{
                    color: disliked ? theme.palette.error.main : theme.palette.text.secondary,
                    '&:hover': {
                      bgcolor: alpha(theme.palette.action.hover, 0.1),
                    },
                  }}
                >
                  <ThumbDownIcon sx={{ fontSize: 16 }} />
                </IconButton>
              </Tooltip>
            </Box>
          )}
        </Box>
      </Box>

      {/* Timestamp - positioned absolutely for user messages */}
      {isUser && (
        <Typography
          variant="caption"
          className="message-timestamp"
          sx={{
            color: alpha(theme.palette.text.secondary, 0.7),
            fontSize: '11px',
            mt: 0.5,
            textAlign: 'right',
          }}
        >
          {formatTime(new Date(message.createdAt))}
        </Typography>
      )}
    </Box>
  );
};

export default React.memo(ChatMessage);